---
import type { Props } from '@astrojs/starlight/props';
import Default from '@astrojs/starlight/components/Sidebar.astro';

const { sidebar } = Astro.props;
const pathname = Astro.url.pathname;
console.log('Pathname debug:', pathname);

let filteredSidebar = sidebar;

// Helper to find specific package groups
// Note: We rely on the structure defined in astro.config.mjs
const packagesGroup = sidebar?.find((group) => group.label === 'Packages' && 'items' in group) as any;

if (pathname.includes('/packages/candid')) {
  // CANDID VIEW
  // Find the candid group inside Packages
  const candidGroup = packagesGroup?.items.find((item: any) => item.label === '@ic-reactor/candid');
  
  if (candidGroup && candidGroup.items) {
     // We want to show the ITEMS of the candid group as the root sidebar
    filteredSidebar = candidGroup.items;
  } else {
    // If not found, try to just show the packages group itself as a fallback
    filteredSidebar = candidGroup ? [candidGroup] : (packagesGroup ? [packagesGroup] : sidebar);
  }
} else if (pathname.includes('/packages/parser')) {
  // PARSER VIEW
  const parserGroup = packagesGroup?.items.find((item: any) => item.label === '@ic-reactor/parser');
   if (parserGroup && parserGroup.items) {
    filteredSidebar = parserGroup.items;
  } else {
    filteredSidebar = parserGroup ? [parserGroup] : (packagesGroup ? [packagesGroup] : sidebar);
  }

} else {
  // CORE / REACT VIEW
  // 1. Filter out 'Packages'
  let coreReactSidebar = sidebar?.filter((group) => group.label !== 'Packages');

  // 2. Tag React-specific items for CSS hiding
  const reactLabels = new Set([
      'Framework',
      'createAuthHooks',
      'createActorHooks',
      'Factories',
      'Examples',
      'Validation',
      'Authentication', 
      'React Setup',
      'Queries',
      'Mutations',
      'Query Caching'
    ]);

  function tagItemsRecursively(items) {
    if (!items) return items;
    return items.map(item => {
      // If the item ITSELF is one of the react labels, tag it (and its children implicitly by hiding parent)
      // Note: Starlight Group doesn't support 'attrs', but Link does.
      // If it's a Group (has items), we can't tag the group node itself easily if Starlight doesn't render attrs for groups.
      // BUT, we can tag all its children? Or maybe Starlight DOES support attrs on groups now?
      // The user error earlier was specific to the Config validation.
      // Here we are modifying the prop passed to the component. The validation might have already passed?
      // Actually, passing invalid props to Default Sidebar might cause runtime error if it checks types.
      // Let's safe-guard: If it's a group, we can't add attrs?
      // Workaround: We will rely on the script to identify specific IDs or text?
      // No, we want CSS. 
      // Strategy: We can wrap the label in a span with a class?
      // Starlight allows HTML in labels? No.
      
      // ALTERNATIVE: We can check if `tagReactItems` works by modifying the `label` to include a zero-width char or unique marker? Hacky.
      
      // BETTER: We can just use the previous JS method BUT execute it synchronously inline to avoid flash.
      // However, the user asked for a "plugin way".
      
      // Let's try adding `attrs` again. The validation error was "Did not match union" in `astro.config.mjs`.
      // Maybe we can add it here at runtime? Starlight might just ignore it or render it.
      // Let's try to add `className` to items if valid.
      
      let newItem = { ...item };
      
      // Check if this item (Group or Link) is in our React list
      const isReactItem = reactLabels.has(newItem.label);
      
      if (isReactItem) {
        // It's a React item.
        // If it sends `attrs` (Links), add class.
        if (!newItem.items) { // It is a Link
           newItem.attrs = { ...newItem.attrs, class: (newItem.attrs?.class || '') + ' react-only' };
        } else {
           // It is a Group. Groups don't support attrs in schema.
           // We have to tag all CHILDREN instead.
           // This is the only way for Groups to "disappear" via CSS (sub-items disappear).
           // But the Group Label will remain? That's bad.
           
           // WAIT. If the group label remains but is empty, it's ugly.
           // Is there ANY property on Group we can abuse? `badge`?
           // badge: { text: 'React', variant: 'note' } -> .starlight-badge
           // Then css: li:has(.starlight-badge) { display: none } (Use :has selector!)
           
           // Let's use `badge` to mark them!
           // Only if it doesn't have one.
           if (!newItem.badge) {
              newItem.badge = { text: 'React', variant: 'default', class: 'react-badge-marker' };
           }
        }
      }
      
      if (newItem.items) {
        newItem.items = tagItemsRecursively(newItem.items);
      }
      
      return newItem;
    });
  }
  
  // Apply tagging
  filteredSidebar = tagItemsRecursively(coreReactSidebar);
}
---
<script is:inline>
  // BLOCKING SCRIPT to apply preference immediately
  const savedMode = localStorage.getItem('docs-preference') || 'react';
  document.documentElement.dataset.packageMode = savedMode;
</script>
---

<Default {...Astro.props} sidebar={filteredSidebar} />
