/**
 * Reactor file generator
 *
 * Generates the shared reactor instance file for a canister.
 */

import type { ReactorConfig, CanisterConfig } from "../types.js"
import {
  toPascalCase,
  getReactorName,
  getServiceTypeName,
} from "../utils/naming.js"

export interface ReactorGeneratorOptions {
  canisterName: string
  canisterConfig: CanisterConfig
  config: ReactorConfig
  outDir: string
}

/**
 * Generate the reactor.ts file content
 */
export function generateReactorFile(options: ReactorGeneratorOptions): string {
  const { canisterName, canisterConfig } = options

  const pascalName = toPascalCase(canisterName)
  const reactorName = getReactorName(canisterName)
  const serviceName = getServiceTypeName(canisterName)
  const reactorType =
    canisterConfig.useDisplayReactor !== false ? "DisplayReactor" : "Reactor"

  // Calculate relative path to client manager
  const clientManagerPath =
    canisterConfig.clientManagerPath ?? "../../lib/client"

  // Calculate relative path to declarations (if they exist)
  const declarationsPath = `./declarations/${canisterName}.did`

  return `/**
 * ${pascalName} Reactor
 *
 * Auto-generated by @ic-reactor/cli
 * This file provides the shared reactor instance for the ${canisterName} canister.
 *
 * You can customize this file to add global configuration.
 */

import { ${reactorType}, createActorHooks, createAuthHooks } from "@ic-reactor/react"
import { clientManager } from "${clientManagerPath}"
import { idlFactory, type _SERVICE } from "${declarationsPath}"

// ═══════════════════════════════════════════════════════════════════════════
// SERVICE TYPE
// ═══════════════════════════════════════════════════════════════════════════

export type ${serviceName} = _SERVICE

// ═══════════════════════════════════════════════════════════════════════════
// REACTOR INSTANCE
// ═══════════════════════════════════════════════════════════════════════════

/**
 * ${pascalName} Reactor with ${canisterConfig.useDisplayReactor !== false ? "Display" : "Candid"} type transformations.
 * ${
   canisterConfig.useDisplayReactor !== false
     ? "Automatically converts bigint → string, Principal → string, etc."
     : "Uses raw Candid types."
 }
 */
export const ${reactorName} = new ${reactorType}<${serviceName}>({
  clientManager,
  idlFactory,
  name: "${canisterName}",
})

// ═══════════════════════════════════════════════════════════════════════════
// BASE HOOKS
// ═══════════════════════════════════════════════════════════════════════════

/**
 * Base actor hooks - use these directly or import method-specific hooks.
 */
export const {
  useActorQuery,
  useActorMutation,
  useActorSuspenseQuery,
  useActorInfiniteQuery,
  useActorSuspenseInfiniteQuery,
  useActorMethod,
} = createActorHooks(${reactorName})

/**
 * Auth hooks for the client manager.
 */
export const { useAuth, useAgentState, useUserPrincipal } = createAuthHooks(clientManager)

// ═══════════════════════════════════════════════════════════════════════════
// RE-EXPORTS
// ═══════════════════════════════════════════════════════════════════════════

export { idlFactory }
`
}
