/**
 * Reactor File Generator
 *
 * Generates the main `index.ts` for a canister — a DisplayReactor instance
 * plus the full set of typed hooks via `createActorHooks`.
 *
 * Generated output example (for canister "backend"):
 *
 *   import { DisplayReactor, createActorHooks } from "@ic-reactor/react"
 *   import { clientManager } from "../../clients"
 *   import { idlFactory, type _SERVICE } from "./declarations/backend"
 *
 *   export type BackendService = _SERVICE
 *
 *   export const backendReactor = new DisplayReactor<BackendService>({ ... })
 *
 *   export const {
 *     useActorQuery: useBackendQuery,
 *     ...
 *   } = createActorHooks(backendReactor)
 */

import path from "node:path"
import { toPascalCase, getReactorName, getServiceTypeName } from "../naming.js"
import type { ReactorMode } from "../types.js"

export interface ReactorGeneratorOptions {
  /** Canister name (e.g. "backend") */
  canisterName: string
  /**
   * Path to the .did file. Used to derive the declarations import path.
   * Can be relative or absolute — only the basename is used.
   */
  didFile: string
  /**
   * Import path for the client manager, relative from the generated reactor file.
   * Default: "../../clients"
   */
  clientManagerPath?: string
  /**
   * Which reactor implementation should back the default exported hooks.
   * Default: "display" (backward compatible)
   */
  reactorMode?: ReactorMode
}

/**
 * Generate the content of a canister's `index.generated.ts` implementation file.
 */
export function generateReactorFile(options: ReactorGeneratorOptions): string {
  const {
    canisterName,
    didFile,
    clientManagerPath = "../../clients",
    reactorMode = "display",
  } = options

  const pascalName = toPascalCase(canisterName)
  const reactorName = getReactorName(canisterName)
  const serviceName = getServiceTypeName(canisterName)
  const rawFactoryName = `create${pascalName}RawReactor`
  const displayFactoryName = `create${pascalName}DisplayReactor`
  const defaultFactoryName =
    reactorMode === "raw" ? rawFactoryName : displayFactoryName

  // Derive the declarations import path from the .did filename
  const baseName = path.basename(didFile, ".did")
  const declarationsPath = `./declarations/${baseName}`

  return `import { DisplayReactor, Reactor, createActorHooks } from "@ic-reactor/react"
import { clientManager } from "${clientManagerPath}"
import { idlFactory, type _SERVICE } from "${declarationsPath}"

export type ${serviceName} = _SERVICE

/**
 * ${pascalName} Reactor
 *
 * Auto-generated by @ic-reactor/codegen — do not edit.
 * Re-run \`ic-reactor generate\` (or the Vite plugin) to regenerate.
 */
export function ${rawFactoryName}() {
  return new Reactor<${serviceName}>({
    clientManager,
    idlFactory,
    name: "${canisterName}",
  })
}

export function ${displayFactoryName}() {
  return new DisplayReactor<${serviceName}>({
    clientManager,
    idlFactory,
    name: "${canisterName}",
  })
}

export const ${reactorName} = ${defaultFactoryName}()

export const ${pascalName}ReactorMode = "${reactorMode}" as const

export const {
  useActorQuery: use${pascalName}Query,
  useActorSuspenseQuery: use${pascalName}SuspenseQuery,
  useActorInfiniteQuery: use${pascalName}InfiniteQuery,
  useActorSuspenseInfiniteQuery: use${pascalName}SuspenseInfiniteQuery,
  useActorMutation: use${pascalName}Mutation,
  useActorMethod: use${pascalName}Method,
} = createActorHooks(${reactorName})
`
}

/**
 * Generate the stable user wrapper `index.ts` for a canister.
 * This file is intended to be created once and preserved across regenerations.
 */
export function generateReactorWrapperFile(
  options: ReactorGeneratorOptions
): string {
  const { canisterName } = options
  const pascalName = toPascalCase(canisterName)

  return `/**
 * ${pascalName} canister exports
 *
 * This wrapper is created once by @ic-reactor/codegen and is not overwritten.
 * Customize it if you need to swap reactor implementations or compose custom exports.
 */
export * from "./index.generated"
`
}
