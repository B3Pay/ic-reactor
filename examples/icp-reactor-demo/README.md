# ğŸš€ IC-Reactor + ICP-CLI Demo

> **Demo for DFINITY DX Team**: Showcasing how ic-reactor integrates seamlessly with the new `icp-cli` and `@icp-sdk/bindgen` workflow.

## Overview

This example demonstrates how to use **ic-reactor** with the new ICP SDK ecosystem:

- **`icp-cli`** - New CLI for building and deploying canisters
- **`@icp-sdk/bindgen`** - Vite plugin to generate TypeScript bindings from `.did` files
- **`@icp-sdk/core/agent/canister-env`** - Runtime canister ID resolution via cookies

## Project Structure

```
icp-reactor-demo/
â”œâ”€â”€ icp.yaml                    # ICP-CLI project config
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ canister.yaml           # Backend canister config
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â””â”€â”€ lib.rs              # Rust canister code
â”‚   â””â”€â”€ dist/
â”‚       â”œâ”€â”€ backend.wasm        # Built canister
â”‚       â””â”€â”€ backend.did         # Candid interface
â””â”€â”€ frontend/
    â”œâ”€â”€ canister.yaml           # Frontend asset canister config
    â”œâ”€â”€ app/
    â”‚   â”œâ”€â”€ package.json
    â”‚   â”œâ”€â”€ vite.config.ts      # Uses @icp-sdk/bindgen plugin
    â”‚   â””â”€â”€ src/
    â”‚       â”œâ”€â”€ App.tsx         # Main app with ic-reactor
    â”‚       â”œâ”€â”€ lib/
    â”‚       â”‚   â””â”€â”€ reactor.ts  # IC-Reactor configuration
    â”‚       â””â”€â”€ backend/
    â”‚           â””â”€â”€ api/        # Generated by bindgen (auto)
    â””â”€â”€ package.json
```

## Key Features

### 1. Zero-Config Canister ID Resolution

With `@icp-sdk/core/agent/canister-env`, canister IDs are served via cookies from the asset canister:

```tsx
import { getCanisterEnv } from "@icp-sdk/core/agent/canister-env"

const canisterEnv = getCanisterEnv<{
  "PUBLIC_CANISTER_ID:backend": string
}>()

const backendId = canisterEnv["PUBLIC_CANISTER_ID:backend"]
```

### 2. Automatic Bindgen Integration

The `@icp-sdk/bindgen` Vite plugin watches your `.did` files and generates TypeScript bindings:

```ts
// vite.config.ts
import { icpBindgen } from "@icp-sdk/bindgen/plugins/vite"

export default defineConfig({
  plugins: [
    react(),
    icpBindgen({
      didFile: "../../backend/dist/backend.did",
      outDir: "./src/backend/api",
    }),
  ],
})
```

### 3. IC-Reactor with Runtime Environment

IC-Reactor can now consume the canister environment automatically:

```tsx
// lib/reactor.ts
import { ClientManager, DisplayReactor } from "@ic-reactor/react"
import { getCanisterEnv } from "@icp-sdk/core/agent/canister-env"
import { idlFactory, type _SERVICE } from "../backend/api/backend"

// Get canister ID from runtime environment (cookie)
const canisterEnv = getCanisterEnv<{
  "PUBLIC_CANISTER_ID:backend": string
}>()

export const reactor = new DisplayReactor<_SERVICE>({
  clientManager,
  canisterId: canisterEnv["PUBLIC_CANISTER_ID:backend"],
  idlFactory,
})
```

## Quick Start

### Prerequisites

- [icp-cli](https://github.com/dfinity/icp-cli) installed
- Node.js 22+
- npm

### 1. Start Local Network

```bash
icp network start
```

### 2. Deploy Canisters

```bash
icp deploy
```

### 3. Run Frontend Dev Server

```bash
cd frontend/app
npm install
npm run dev
```

### 4. Open in Browser

Visit `http://<frontend_canister_id>.localhost:8000/`

## Before vs After

### âŒ Before (Hard-coded IDs)

```tsx
// Required: .env file with CANISTER_ID_BACKEND
// Required: Vite define block for process.env
// Required: Rebuild for each environment

const canisterId = process.env.CANISTER_ID_BACKEND // ğŸ˜± Hard-coded at build time
```

### âœ… After (Runtime Resolution)

```tsx
// No .env file needed!
// No rebuild for production!
// Works on any network automatically!

import { getCanisterEnv } from "@icp-sdk/core/agent/canister-env"
const { "PUBLIC_CANISTER_ID:backend": canisterId } = getCanisterEnv()
```

## Demo Flow for Raymond

1. **Show icp.yaml** - Single config file for the whole project
2. **Run `icp deploy`** - One command deploys everything
3. **Explain cookie flow** - Asset canister serves IDs via `ic_env` cookie
4. **Show reactor.ts** - Clean integration with `@icp-sdk/core`
5. **Edit backend** - Change `.did`, bindings regenerate automatically
6. **Deploy to mainnet** - Same frontend works without rebuild!

---

**Made with â¤ï¸ by Behrad Deylami for the DFINITY DX Team**
